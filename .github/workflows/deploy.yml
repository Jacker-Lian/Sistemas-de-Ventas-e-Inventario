name: Deploy Frontend and Backend to Server

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Clonar el repositorio
      - name: Checkout code
        uses: actions/checkout@v4

      # 2️⃣ Construir el frontend (React)
      - name: Build frontend
        run: |
          cd frontend
          npm ci
          npm run build
          cd ..

      # 3️⃣ Instalar dependencias del backend (sin ejecutar)
      - name: Prepare backend
        run: |
          cd backend
          npm ci
          cd ..

      # 4️⃣ Empaquetar todo en un solo archivo
      - name: Package frontend and backend
        run: |
          tar -czf deploy.tar.gz backend frontend/dist

      # 5️⃣ Subir al servidor y desplegar
      - name: Upload and deploy to server
        env:
          SSH_HOST: 38.250.161.15        
          SSH_USER: root                 
          SSH_PASS: sector7          
        run: |
          sudo apt-get update -y
          sudo apt-get install -y sshpass

          # Subir el archivo comprimido
          sshpass -p "$SSH_PASS" scp -o StrictHostKeyChecking=no -P 22 deploy.tar.gz $SSH_USER@$SSH_HOST:~/

          # Conectarse al servidor y desplegar
          sshpass -p "$SSH_PASS" ssh -o StrictHostKeyChecking=no -p 22 $SSH_USER@$SSH_HOST << 'EOF'
            mkdir -p ~/app
            cd ~/app
            mv ~/deploy.tar.gz .
            tar -xzf deploy.tar.gz
            rm deploy.tar.gz

            # Reiniciar backend con PM2 (si existe)
            if command -v pm2 &> /dev/null
            then
              cd backend
              pm2 startOrReload ecosystem.config.js || pm2 restart all
            else
              echo "⚠️ pm2 no está instalado, iniciando el backend manualmente..."
              cd backend
              nohup npm start &
            fi
          EOF
