name: Build and Deploy to Server

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout código
        uses: actions/checkout@v4

      # --- Construcción del proyecto ---
      - name: Instalar dependencias y construir Frontend
        run: |
          cd frontend
          npm ci
          npm run build

      - name: Instalar dependencias del Backend
        run: |
          cd backend
          npm ci

      # --- Crear archivo comprimido ---
      - name: Crear archivo comprimido
        run: |
          tar -czf deploy.tar.gz backend frontend/dist

      # --- Subir al servidor remoto ---
      - name: Subir y desplegar en el servidor
        run: |
          # CONFIGURA AQUÍ tus credenciales
          SERVER_HOST="38.250.161.15"
          SERVER_USER="root"
          SERVER_PORT="22"
          SERVER_PASSWORD="sector7" # opcional si usas clave
          TARGET_DIR="~/app"

          # Instalar sshpass (para usar contraseña sin secretos)
          sudo apt-get update -y
          sudo apt-get install -y sshpass

          # Crear directorio remoto si no existe
          sshpass -p "$SERVER_PASSWORD" ssh -o StrictHostKeyChecking=no -p $SERVER_PORT $SERVER_USER@$SERVER_HOST "mkdir -p $TARGET_DIR"

          # Subir el archivo comprimido
          sshpass -p "$SERVER_PASSWORD" scp -P $SERVER_PORT -o StrictHostKeyChecking=no deploy.tar.gz $SERVER_USER@$SERVER_HOST:$TARGET_DIR/

          # Descomprimir en el servidor
          sshpass -p "$SERVER_PASSWORD" ssh -o StrictHostKeyChecking=no -p $SERVER_PORT $SERVER_USER@$SERVER_HOST "
            cd $TARGET_DIR &&
            tar -xzf deploy.tar.gz &&
            rm deploy.tar.gz &&
            echo '✅ Despliegue completado en $TARGET_DIR'
          "
